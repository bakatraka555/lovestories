<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Naruƒçi Transformaciju - Love Stories Museum</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .template-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }

        .template-info h2 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .template-info p {
            opacity: 0.9;
            font-size: 14px;
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .upload-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .upload-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .upload-option {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .upload-option:hover {
            background: #e9ecef;
            border-color: #764ba2;
        }

        .upload-option input[type="file"] {
            display: none;
        }

        .upload-option label {
            cursor: pointer;
            display: block;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .upload-text {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }

        .upload-hint {
            font-size: 12px;
            color: #666;
        }

        .preview-section {
            margin-bottom: 30px;
        }

        .preview-images {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .preview-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 1;
            background: #f8f9fa;
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-item .remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .generate-button {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 20px;
        }

        .generate-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .generate-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            margin-top: 30px;
            display: none;
        }

        .results-section.show {
            display: block;
        }

        .result-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .result-item h4 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .result-item img,
        .result-item video {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .download-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
        }

        .download-button:hover {
            background: #764ba2;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #c33;
        }

        .info-box {
            background: #e7f3ff;
            color: #0066cc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #0066cc;
            font-size: 14px;
        }

        @media (max-width: 600px) {
            .upload-options {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üíë Naruƒçi Svoju Transformaciju</h1>
        <p class="subtitle">Uploadaj svoje slike i dobit ƒáe≈° AI transformaciju</p>

        <div class="template-info" id="templateInfo">
            <h2>Uƒçitavanje template-a...</h2>
            <p>Molimo priƒçekajte</p>
        </div>

        <div class="upload-section">
            <h3>üì∏ Odaberi Slike</h3>
            <div class="info-box">
                üí° Mo≈æe≈° uploadati <strong>1 sliku s parom</strong> ili <strong>2 odvojene slike</strong> (jedna po osobi)
            </div>
            
            <div class="upload-options">
                <div class="upload-option">
                    <input type="file" id="coupleImage" accept="image/*" />
                    <label for="coupleImage">
                        <div class="upload-icon">üë´</div>
                        <div class="upload-text">Par na jednoj slici</div>
                        <div class="upload-hint">1 slika</div>
                    </label>
                </div>
                <div class="upload-option">
                    <input type="file" id="person1Image" accept="image/*" />
                    <label for="person1Image">
                        <div class="upload-icon">üë§</div>
                        <div class="upload-text">Osoba 1</div>
                        <div class="upload-hint">1. slika</div>
                    </label>
                </div>
            </div>
            <div class="upload-options">
                <div class="upload-option" style="grid-column: 1 / -1;">
                    <input type="file" id="person2Image" accept="image/*" />
                    <label for="person2Image">
                        <div class="upload-icon">üë§</div>
                        <div class="upload-text">Osoba 2 (opciono)</div>
                        <div class="upload-hint">2. slika - samo ako koristi≈° odvojene slike</div>
                    </label>
                </div>
            </div>

            <div class="preview-section" id="previewSection" style="display: none;">
                <h3>üëÄ Pregled</h3>
                <div class="preview-images" id="previewImages"></div>
            </div>
        </div>

        <div id="errorMessage" class="error" style="display: none;"></div>

        <button class="generate-button" id="generateButton" disabled>
            ‚ú® Generiraj Transformaciju
        </button>

        <div class="loading" id="loadingSection" style="display: none;">
            <div class="loading-spinner"></div>
            <p>AI generira tvoju transformaciju...</p>
            <p style="font-size: 14px; color: #666; margin-top: 10px;">Ovo mo≈æe potrajati 1-2 minute</p>
        </div>

        <div class="results-section" id="resultsSection">
            <h3>üéâ Tvoja Transformacija je Spremna!</h3>
            <div id="resultsContainer"></div>
        </div>
    </div>

    <script>
        // Get template from URL
        const urlParams = new URLSearchParams(window.location.search);
        const templateId = urlParams.get('template');
        
        let currentTemplate = null;
        let uploadedImages = {
            couple: null,
            person1: null,
            person2: null
        };

        // Load template info
        async function loadTemplateInfo() {
            try {
                const response = await fetch('docs/couples-templates-database.json');
                const data = await response.json();
                currentTemplate = data.templates.find(t => t.id === templateId);
                
                if (currentTemplate) {
                    document.getElementById('templateInfo').innerHTML = `
                        <h2>${currentTemplate.number}. ${currentTemplate.name}</h2>
                        <p>${currentTemplate.description}</p>
                    `;
                } else {
                    document.getElementById('templateInfo').innerHTML = `
                        <h2>Template nije pronaƒëen</h2>
                        <p>Molimo vratite se i odaberite template ponovno</p>
                    `;
                }
            } catch (error) {
                console.error('Error loading template:', error);
                document.getElementById('templateInfo').innerHTML = `
                    <h2>Gre≈°ka pri uƒçitavanju</h2>
                    <p>Molimo osvje≈æite stranicu</p>
                `;
            }
        }

        // File upload handlers
        document.getElementById('coupleImage').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                uploadedImages.couple = e.target.files[0];
                uploadedImages.person1 = null;
                uploadedImages.person2 = null;
                document.getElementById('person1Image').value = '';
                document.getElementById('person2Image').value = '';
                updatePreview();
            }
        });

        document.getElementById('person1Image').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                uploadedImages.person1 = e.target.files[0];
                uploadedImages.couple = null;
                document.getElementById('coupleImage').value = '';
                updatePreview();
            }
        });

        document.getElementById('person2Image').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                uploadedImages.person2 = e.target.files[0];
                updatePreview();
            }
        });

        // Update preview
        function updatePreview() {
            const previewSection = document.getElementById('previewSection');
            const previewImages = document.getElementById('previewImages');
            previewImages.innerHTML = '';

            if (uploadedImages.couple) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImages.innerHTML = `
                        <div class="preview-item">
                            <img src="${e.target.result}" alt="Par">
                            <button class="remove" onclick="removeImage('couple')">√ó</button>
                        </div>
                    `;
                    previewSection.style.display = 'block';
                    checkGenerateButton();
                };
                reader.readAsDataURL(uploadedImages.couple);
            } else if (uploadedImages.person1) {
                const images = [];
                const readers = [];
                
                if (uploadedImages.person1) {
                    const reader1 = new FileReader();
                    reader1.onload = function(e) {
                        images.push({src: e.target.result, type: 'person1'});
                        if (images.length === (uploadedImages.person2 ? 2 : 1)) {
                            displayPreview(images);
                        }
                    };
                    readers.push(reader1);
                    reader1.readAsDataURL(uploadedImages.person1);
                }
                
                if (uploadedImages.person2) {
                    const reader2 = new FileReader();
                    reader2.onload = function(e) {
                        images.push({src: e.target.result, type: 'person2'});
                        if (images.length === 2) {
                            displayPreview(images);
                        }
                    };
                    readers.push(reader2);
                    reader2.readAsDataURL(uploadedImages.person2);
                }
            }
        }

        function displayPreview(images) {
            const previewImages = document.getElementById('previewImages');
            previewImages.innerHTML = images.map((img, index) => `
                <div class="preview-item">
                    <img src="${img.src}" alt="Osoba ${index + 1}">
                    <button class="remove" onclick="removeImage('${img.type}')">√ó</button>
                </div>
            `).join('');
            document.getElementById('previewSection').style.display = 'block';
            checkGenerateButton();
        }

        function removeImage(type) {
            if (type === 'couple') {
                uploadedImages.couple = null;
                document.getElementById('coupleImage').value = '';
            } else if (type === 'person1') {
                uploadedImages.person1 = null;
                document.getElementById('person1Image').value = '';
            } else if (type === 'person2') {
                uploadedImages.person2 = null;
                document.getElementById('person2Image').value = '';
            }
            
            if (!uploadedImages.couple && !uploadedImages.person1) {
                document.getElementById('previewSection').style.display = 'none';
            } else {
                updatePreview();
            }
            checkGenerateButton();
        }

        function checkGenerateButton() {
            const hasImages = uploadedImages.couple || uploadedImages.person1;
            document.getElementById('generateButton').disabled = !hasImages || !currentTemplate;
        }

        // Generate transformation
        document.getElementById('generateButton').addEventListener('click', async function() {
            if (!currentTemplate) {
                showError('Template nije uƒçitan. Molimo osvje≈æite stranicu.');
                return;
            }

            const hasImages = uploadedImages.couple || uploadedImages.person1;
            if (!hasImages) {
                showError('Molimo odaberite barem jednu sliku.');
                return;
            }

            // Hide error, show loading
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('resultsSection').classList.remove('show');
            document.getElementById('generateButton').disabled = true;

            try {
                // Konvertuj slike u base64
                const image1Promise = uploadedImages.couple 
                    ? fileToBase64(uploadedImages.couple)
                    : fileToBase64(uploadedImages.person1);
                
                const image2Promise = uploadedImages.person2 
                    ? fileToBase64(uploadedImages.person2)
                    : Promise.resolve(null);

                const [image1Base64, image2Base64] = await Promise.all([image1Promise, image2Promise]);
                const isCouple = !!uploadedImages.couple;

                // Pozovi Netlify Function za generiranje
                console.log('Calling generate-image function...');
                const generateResponse = await fetch('/.netlify/functions/generate-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        templateId: currentTemplate.id,
                        image1: image1Base64,
                        image2: image2Base64,
                        isCouple: isCouple
                    })
                });

                // Prvo proƒçitaj kao text da vidimo ≈°to se vraƒáa
                const responseText = await generateResponse.text();
                console.log('Response status:', generateResponse.status);
                console.log('Response headers:', Object.fromEntries(generateResponse.headers.entries()));
                console.log('Response text (first 500 chars):', responseText.substring(0, 500));
                
                // Parse response body samo jednom
                let generateResult;
                try {
                    generateResult = JSON.parse(responseText);
                } catch (e) {
                    // Ako JSON parsing ne uspije, poka≈æi ≈°to se stvarno vratilo
                    console.error('Failed to parse JSON response:', e);
                    console.error('Full response text:', responseText);
                    throw new Error('Failed to parse response: ' + (e.message || 'Invalid JSON') + '. Response: ' + responseText.substring(0, 200));
                }

                if (!generateResponse.ok) {
                    throw new Error(generateResult.error || generateResult.details || 'Generation failed');
                }

                console.log('Generation result:', generateResult);

                if (!generateResult.success || !generateResult.predictionId) {
                    console.error('Missing success or predictionId in result:', {
                        success: generateResult.success,
                        predictionId: generateResult.predictionId,
                        fullResult: generateResult
                    });
                    throw new Error('No prediction ID returned');
                }

                const predictionId = generateResult.predictionId;
                console.log('Prediction ID:', predictionId);
                console.log('Polling for prediction status...');

                // Poll status dok nije "succeeded" ili "failed"
                let statusResult;
                let maxAttempts = 150; // Max 5 minuta (150 * 2 sekunde)
                let attempt = 0;

                while (attempt < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 2000)); // ƒåekaj 2 sekunde
                    attempt++;

                    console.log(`Checking prediction status (attempt ${attempt}/${maxAttempts})...`);
                    
                    const statusResponse = await fetch(`/.netlify/functions/check-prediction-status?predictionId=${predictionId}`);
                    const statusText = await statusResponse.text();
                    
                    try {
                        statusResult = JSON.parse(statusText);
                    } catch (e) {
                        console.error('Failed to parse status response:', e);
                        console.error('Status response text:', statusText);
                        throw new Error('Failed to parse status response');
                    }

                    if (!statusResponse.ok) {
                        throw new Error(statusResult.error || 'Status check failed');
                    }

                    console.log(`Prediction status: ${statusResult.status} (attempt ${attempt})`);

                    if (statusResult.status === 'succeeded') {
                        console.log('Generation successful! Image URL:', statusResult.imageUrl);
                        break;
                    } else if (statusResult.status === 'failed') {
                        throw new Error(statusResult.error || 'Generation failed');
                    } else if (statusResult.status === 'canceled') {
                        throw new Error('Generation was canceled');
                    }
                    // Ako je "starting" ili "processing", nastavi poll-ati
                }

                if (attempt >= maxAttempts) {
                    throw new Error('Generation timeout - prediction took too long');
                }

                if (!statusResult.imageUrl) {
                    throw new Error('No image URL in result');
                }

                // Upload na Bunny.net
                console.log('Uploading to Bunny.net...');
                console.log('Calling upload-to-bunny with:', {
                    imageUrl: statusResult.imageUrl,
                    templateId: currentTemplate.id,
                    userId: generateUserId()
                });
                const uploadResponse = await fetch('/.netlify/functions/upload-to-bunny', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        imageUrl: statusResult.imageUrl,
                        templateId: currentTemplate.id,
                        userId: generateUserId() // Generiraj unique user ID
                    })
                });

                // Parse response body samo jednom
                let uploadResult;
                try {
                    uploadResult = await uploadResponse.json();
                } catch (e) {
                    // Ako json() ne uspije, body je veƒá potro≈°en - ne poku≈°avaj ƒçitati text()
                    console.error('Failed to parse upload JSON response:', e);
                    throw new Error('Failed to parse upload response: ' + (e.message || 'Invalid JSON'));
                }

                if (!uploadResponse.ok) {
                    throw new Error(uploadResult.error || uploadResult.details || 'Upload failed');
                }

                console.log('Upload result:', uploadResult);

                // Prika≈æi rezultate
                showResults(uploadResult.cdnUrl, null);
                
            } catch (error) {
                console.error('Generation error:', error);
                showError('Gre≈°ka pri generiranju: ' + error.message);
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('generateButton').disabled = false;
            }
        });

        // Helper funkcije
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function generateUserId() {
            return 'user-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function showResults(imageUrl, videoUrl) {
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = '';
            
            if (imageUrl) {
                const imageDiv = document.createElement('div');
                imageDiv.className = 'result-item';
                imageDiv.innerHTML = `
                    <h4>üì∏ Transformirana Slika</h4>
                    <img src="${imageUrl}" alt="Rezultat">
                    <a href="${imageUrl}" download="lovestories-image.jpg" class="download-button">‚¨áÔ∏è Download Sliku</a>
                `;
                resultsContainer.appendChild(imageDiv);
            }
            
            if (videoUrl) {
                const videoDiv = document.createElement('div');
                videoDiv.className = 'result-item';
                videoDiv.innerHTML = `
                    <h4>üé¨ Transformirani Video</h4>
                    <video src="${videoUrl}" controls></video>
                    <a href="${videoUrl}" download="lovestories-video.mp4" class="download-button">‚¨áÔ∏è Download Video</a>
                `;
                resultsContainer.appendChild(videoDiv);
            }
            
            document.getElementById('resultsSection').classList.add('show');
            document.getElementById('loadingSection').style.display = 'none';
        }

        // Initialize
        loadTemplateInfo();
        checkGenerateButton();
    </script>
</body>
</html>

