<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Your Transformation - Love Stories Museum</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.3/dist/heic2any.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .template-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }

        .template-info h2 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .template-info p {
            opacity: 0.9;
            font-size: 14px;
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .upload-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .upload-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .upload-option {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .upload-option:hover {
            background: #e9ecef;
            border-color: #764ba2;
        }

        .upload-option input[type="file"] {
            display: none;
        }

        .upload-option label {
            cursor: pointer;
            display: block;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .upload-text {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }

        .upload-hint {
            font-size: 12px;
            color: #666;
        }

        .upload-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .upload-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            flex: 1;
            max-width: 150px;
        }

        .upload-btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .upload-btn:active {
            transform: translateY(0);
        }

        .preview-section {
            margin-bottom: 30px;
        }

        .preview-images {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .preview-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 1;
            background: #f8f9fa;
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-item .remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .generate-button {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 20px;
        }

        .generate-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .generate-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Progress Bar Styles */
        .progress-container {
            margin: 30px 0;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            margin: 15px 0;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 6px;
            transition: width 0.5s ease;
            width: 0%;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-text {
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
            margin: 10px 0 5px 0;
        }

        .time-estimate {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        /* Step Indicators */
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s;
            position: relative;
        }

        .step.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .step.completed {
            background: #28a745;
            color: white;
        }

        .step-icon {
            font-size: 20px;
            margin-right: 8px;
        }

        .loading-message-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        /* Error Recovery */
        .error-recovery {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .error-recovery h4 {
            color: #856404;
            margin-bottom: 15px;
        }

        .error-recovery-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .retry-button, .save-button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .retry-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .retry-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .save-button {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #667eea;
        }

        .save-button:hover {
            background: #e9ecef;
        }

        /* Validation Messages */
        .validation-message {
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            display: none;
        }

        .validation-message.show {
            display: block;
        }

        .validation-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .validation-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .validation-message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .results-section {
            margin-top: 30px;
            display: none;
        }

        .results-section.show {
            display: block;
        }

        .result-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .result-item h4 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .result-item img,
        .result-item video {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .download-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
        }

        .download-button:hover {
            background: #764ba2;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #c33;
        }

        .info-box {
            background: #e7f3ff;
            color: #0066cc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #0066cc;
            font-size: 14px;
        }

        @media (max-width: 600px) {
            .upload-options {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üíë Order Your Transformation</h1>
        <p class="subtitle">Upload your photos and get an AI transformation</p>

        <div class="template-info" id="templateInfo">
            <h2>Loading template...</h2>
            <p>Please wait</p>
        </div>

        <div class="upload-section">
            <h3>üì∏ Select Photos</h3>
            <div class="info-box">
                üí° You can upload <strong>1 photo with both of you</strong> or <strong>2 separate photos</strong> (one per person)<br>
                üì± On mobile you can choose a photo from <strong>gallery</strong> or <strong>take a new one with camera</strong>
            </div>
            
            <div class="upload-options">
                <div class="upload-option">
                    <input type="file" id="coupleImage" accept="image/*" style="display: none;" />
                    <div class="upload-icon">üë´</div>
                    <div class="upload-text">Couple in one photo</div>
                    <div class="upload-buttons">
                        <button type="button" class="upload-btn" onclick="triggerFileInput('coupleImage', false)">üìÅ Gallery</button>
                        <button type="button" class="upload-btn" onclick="triggerFileInput('coupleImage', true)">üì∑ Camera</button>
                    </div>
                </div>
                <div class="upload-option">
                    <input type="file" id="person1Image" accept="image/*" style="display: none;" />
                    <div class="upload-icon">üë§</div>
                    <div class="upload-text">Person 1</div>
                    <div class="upload-buttons">
                        <button type="button" class="upload-btn" onclick="triggerFileInput('person1Image', false)">üìÅ Gallery</button>
                        <button type="button" class="upload-btn" onclick="triggerFileInput('person1Image', true)">üì∑ Camera</button>
                    </div>
                </div>
            </div>
            <div class="upload-options">
                <div class="upload-option" style="grid-column: 1 / -1;">
                    <input type="file" id="person2Image" accept="image/*" style="display: none;" />
                    <div class="upload-icon">üë§</div>
                    <div class="upload-text">Person 2 (optional)</div>
                    <div class="upload-buttons">
                        <button type="button" class="upload-btn" onclick="triggerFileInput('person2Image', false)">üìÅ Gallery</button>
                        <button type="button" class="upload-btn" onclick="triggerFileInput('person2Image', true)">üì∑ Camera</button>
                    </div>
                    <div class="upload-hint" style="margin-top: 10px; font-size: 12px; color: #666;">Only if using separate photos</div>
                </div>
            </div>

            <div class="preview-section" id="previewSection" style="display: none;">
                <h3>üëÄ Preview</h3>
                <div class="preview-images" id="previewImages"></div>
            </div>
        </div>

        <!-- Validation Messages -->
        <div id="validationMessage" class="validation-message"></div>
        
        <!-- Error Message with Recovery -->
        <div id="errorMessage" class="error" style="display: none;">
            <div id="errorContent"></div>
            <div class="error-recovery" id="errorRecovery" style="display: none;">
                <h4>What would you like to do?</h4>
                <div class="error-recovery-buttons">
                    <button class="retry-button" onclick="retryGeneration()">üîÑ Try Again</button>
                    <button class="save-button" onclick="saveProgress()">üíæ Save Progress</button>
                </div>
            </div>
        </div>

        <button class="generate-button" id="generateButton" disabled>
            ‚ú® Generate Transformation
        </button>

        <div class="loading" id="loadingSection" style="display: none;">
            <div class="loading-spinner"></div>
            
            <!-- Step Indicators -->
            <div class="step-indicator" id="stepIndicator">
                <div class="step" id="step1" data-step="1">üì§</div>
                <div class="step" id="step2" data-step="2">ü§ñ</div>
                <div class="step" id="step3" data-step="3">‚ú®</div>
                <div class="step" id="step4" data-step="4">üé®</div>
                <div class="step" id="step5" data-step="5">üé≠</div>
                <div class="step" id="step6" data-step="6">‚úÖ</div>
            </div>
            
            <!-- Loading Message -->
            <div class="loading-message-container">
                <span class="step-icon" id="stepIcon">üì§</span>
                <p id="loadingMessage">AI is generating your transformation...</p>
            </div>
            
            <!-- Progress Bar -->
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">0%</div>
                <div class="time-estimate" id="timeEstimate">Estimated time: ~2 minutes</div>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <h3>üéâ Your Transformation is Ready!</h3>
            <div id="resultsContainer"></div>
        </div>
    </div>

    <script>
        // Get template from URL
        const urlParams = new URLSearchParams(window.location.search);
        const templateId = urlParams.get('template');
        
        let currentTemplate = null;
        let uploadedImages = {
            couple: null,
            person1: null,
            person2: null
        };

        // Load template info
        async function loadTemplateInfo() {
            try {
                const response = await fetch('docs/couples-templates-database.json');
                const data = await response.json();
                currentTemplate = data.templates.find(t => t.id === templateId);
                
                if (currentTemplate) {
                    document.getElementById('templateInfo').innerHTML = `
                        <h2>${currentTemplate.number}. ${currentTemplate.name}</h2>
                        <p>${currentTemplate.description}</p>
                    `;
                } else {
                    document.getElementById('templateInfo').innerHTML = `
                        <h2>Template not found</h2>
                        <p>Please go back and select a template again</p>
                    `;
                }
            } catch (error) {
                console.error('Error loading template:', error);
                document.getElementById('templateInfo').innerHTML = `
                    <h2>Error loading</h2>
                    <p>Please refresh the page</p>
                `;
            }
        }

        // Function to trigger file input with or without capture
        function triggerFileInput(inputId, useCamera) {
            const input = document.getElementById(inputId);
            if (useCamera) {
                input.setAttribute('capture', 'environment');
            } else {
                input.removeAttribute('capture');
            }
            input.click();
        }

        // File upload handlers with validation and HEIC conversion
        document.getElementById('coupleImage').addEventListener('change', async function(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                try {
                    // Provjeri je li HEIC
                    const isHeic = file.type === 'image/heic' || file.type === 'image/heif' || 
                                   file.name.toLowerCase().endsWith('.heic') || 
                                   file.name.toLowerCase().endsWith('.heif');
                    
                    let processedFile = file;
                    
                    // Ako je HEIC, konvertuj s kratkom porukom
                    if (isHeic) {
                        showValidationMessage('üîÑ Converting Samsung HEIC to JPEG...', 'warning');
                        processedFile = await convertHeicToJpegInBrowser(file);
                        showValidationMessage('‚úÖ Converted successfully!', 'success');
                    }
                    
                    await validateImage(processedFile);
                    uploadedImages.couple = processedFile;
                    uploadedImages.person1 = null;
                    uploadedImages.person2 = null;
                    document.getElementById('person1Image').value = '';
                    document.getElementById('person2Image').value = '';
                    
                    // Ako nije HEIC, normalna poruka
                    if (!isHeic) {
                        showValidationMessage(`‚úÖ Image validated! (${(file.size / 1024 / 1024).toFixed(1)}MB)`, 'success');
                    }
                    
                    updatePreview();
                } catch (error) {
                    const errorMsg = error?.message || error?.toString() || 'Invalid image file';
                    showValidationMessage(`‚ùå ${errorMsg}`, 'error');
                    e.target.value = ''; // Clear invalid file
                    uploadedImages.couple = null;
                }
            }
        });

        document.getElementById('person1Image').addEventListener('change', async function(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                try {
                    // Provjeri je li HEIC
                    const isHeic = file.type === 'image/heic' || file.type === 'image/heif' || 
                                   file.name.toLowerCase().endsWith('.heic') || 
                                   file.name.toLowerCase().endsWith('.heif');
                    
                    let processedFile = file;
                    
                    // Ako je HEIC, konvertuj s kratkom porukom
                    if (isHeic) {
                        showValidationMessage('üîÑ Converting Samsung HEIC to JPEG...', 'warning');
                        processedFile = await convertHeicToJpegInBrowser(file);
                        showValidationMessage('‚úÖ Converted successfully!', 'success');
                    }
                    
                    await validateImage(processedFile);
                    uploadedImages.person1 = processedFile;
                    uploadedImages.couple = null;
                    document.getElementById('coupleImage').value = '';
                    
                    // Ako nije HEIC, normalna poruka
                    if (!isHeic) {
                        showValidationMessage(`‚úÖ Image validated! (${(file.size / 1024 / 1024).toFixed(1)}MB)`, 'success');
                    }
                    
                    updatePreview();
                } catch (error) {
                    const errorMsg = error?.message || error?.toString() || 'Invalid image file';
                    showValidationMessage(`‚ùå ${errorMsg}`, 'error');
                    e.target.value = ''; // Clear invalid file
                    uploadedImages.person1 = null;
                }
            }
        });

        document.getElementById('person2Image').addEventListener('change', async function(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                try {
                    // Provjeri je li HEIC
                    const isHeic = file.type === 'image/heic' || file.type === 'image/heif' || 
                                   file.name.toLowerCase().endsWith('.heic') || 
                                   file.name.toLowerCase().endsWith('.heif');
                    
                    let processedFile = file;
                    
                    // Ako je HEIC, konvertuj s kratkom porukom
                    if (isHeic) {
                        showValidationMessage('üîÑ Converting Samsung HEIC to JPEG...', 'warning');
                        processedFile = await convertHeicToJpegInBrowser(file);
                        showValidationMessage('‚úÖ Converted successfully!', 'success');
                    }
                    
                    await validateImage(processedFile);
                    uploadedImages.person2 = processedFile;
                    
                    // Ako nije HEIC, normalna poruka
                    if (!isHeic) {
                        showValidationMessage(`‚úÖ Image validated! (${(file.size / 1024 / 1024).toFixed(1)}MB)`, 'success');
                    }
                    
                    updatePreview();
                } catch (error) {
                    const errorMsg = error?.message || error?.toString() || 'Invalid image file';
                    showValidationMessage(`‚ùå ${errorMsg}`, 'error');
                    e.target.value = ''; // Clear invalid file
                    uploadedImages.person2 = null;
                }
            }
        });

        // Update preview
        function updatePreview() {
            const previewSection = document.getElementById('previewSection');
            const previewImages = document.getElementById('previewImages');
            previewImages.innerHTML = '';

            if (uploadedImages.couple) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImages.innerHTML = `
                        <div class="preview-item">
                            <img src="${e.target.result}" alt="Par">
                            <button class="remove" onclick="removeImage('couple')">√ó</button>
                        </div>
                    `;
                    previewSection.style.display = 'block';
                    checkGenerateButton();
                };
                reader.readAsDataURL(uploadedImages.couple);
            } else if (uploadedImages.person1) {
                const images = [];
                const readers = [];
                
                if (uploadedImages.person1) {
                    const reader1 = new FileReader();
                    reader1.onload = function(e) {
                        images.push({src: e.target.result, type: 'person1'});
                        if (images.length === (uploadedImages.person2 ? 2 : 1)) {
                            displayPreview(images);
                        }
                    };
                    readers.push(reader1);
                    reader1.readAsDataURL(uploadedImages.person1);
                }
                
                if (uploadedImages.person2) {
                    const reader2 = new FileReader();
                    reader2.onload = function(e) {
                        images.push({src: e.target.result, type: 'person2'});
                        if (images.length === 2) {
                            displayPreview(images);
                        }
                    };
                    readers.push(reader2);
                    reader2.readAsDataURL(uploadedImages.person2);
                }
            }
        }

        function displayPreview(images) {
            const previewImages = document.getElementById('previewImages');
            previewImages.innerHTML = images.map((img, index) => `
                <div class="preview-item">
                    <img src="${img.src}" alt="Person ${index + 1}">
                    <button class="remove" onclick="removeImage('${img.type}')">√ó</button>
                </div>
            `).join('');
            document.getElementById('previewSection').style.display = 'block';
            checkGenerateButton();
        }

        function removeImage(type) {
            if (type === 'couple') {
                uploadedImages.couple = null;
                document.getElementById('coupleImage').value = '';
            } else if (type === 'person1') {
                uploadedImages.person1 = null;
                document.getElementById('person1Image').value = '';
            } else if (type === 'person2') {
                uploadedImages.person2 = null;
                document.getElementById('person2Image').value = '';
            }
            
            if (!uploadedImages.couple && !uploadedImages.person1) {
                document.getElementById('previewSection').style.display = 'none';
            } else {
                updatePreview();
            }
            checkGenerateButton();
        }

        function checkGenerateButton() {
            const hasImages = uploadedImages.couple || uploadedImages.person1;
            document.getElementById('generateButton').disabled = !hasImages || !currentTemplate;
        }

        // Generate transformation
        document.getElementById('generateButton').addEventListener('click', async function() {
            if (!currentTemplate) {
                showError('Template not loaded. Please refresh the page.');
                return;
            }

            const hasImages = uploadedImages.couple || uploadedImages.person1;
            if (!hasImages) {
                showError('Please select at least one photo.');
                return;
            }

            // Hide error, show loading
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('resultsSection').classList.remove('show');
            document.getElementById('generateButton').disabled = true;
            
            // Start progress tracking
            startProgressTracking();
            
            // Save generation data for retry
            saveGenerationData({
                templateId: currentTemplate.id,
                uploadedImages: uploadedImages,
                isCouple: !!uploadedImages.couple
            });

            try {
                const isCouple = !!uploadedImages.couple;
                
                // NOVO: Uploadaj slike na Bunny.net PRVO (smanjuje request size za 90%+)
                const userId = generateUserId();
                updateLoadingStep(1, 'Uploading images...');
                
                // Konvertuj i uploadaj image1
                const image1File = uploadedImages.couple || uploadedImages.person1;
                const image1Base64 = await fileToBase64(image1File);
                const image1Filename = `${userId}-image1.jpg`;
                
                console.log('Uploading image1 to Bunny.net...');
                const upload1Response = await fetch('/.netlify/functions/upload-user-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        imageBase64: image1Base64,
                        filename: image1Filename
                    })
                });
                
                let upload1Result;
                try {
                    const upload1Text = await upload1Response.text();
                    if (!upload1Text || upload1Text.trim().length === 0) {
                        throw new Error('Empty response from upload service. Please try again.');
                    }
                    upload1Result = JSON.parse(upload1Text);
                } catch (parseError) {
                    console.error('Failed to parse upload1 response:', parseError);
                    throw new Error('Failed to upload image1: Invalid response from server. Please try again.');
                }
                
                if (!upload1Response.ok || !upload1Result.success) {
                    throw new Error(upload1Result.error || upload1Result.details || 'Failed to upload image1');
                }
                const image1Url = upload1Result.url;
                console.log('Image1 uploaded successfully:', image1Url);
                
                // Uploadaj image2 ako postoji
                let image2Url = null;
                if (!isCouple && uploadedImages.person2) {
                    updateLoadingStep(1, 'Uploading second image...');
                    
                    const image2Base64 = await fileToBase64(uploadedImages.person2);
                    const image2Filename = `${userId}-image2.jpg`;
                    
                    console.log('Uploading image2 to Bunny.net...');
                    const upload2Response = await fetch('/.netlify/functions/upload-user-image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            imageBase64: image2Base64,
                            filename: image2Filename
                        })
                    });
                    
                    let upload2Result;
                    try {
                        const upload2Text = await upload2Response.text();
                        if (!upload2Text || upload2Text.trim().length === 0) {
                            throw new Error('Empty response from upload service. Please try again.');
                        }
                        upload2Result = JSON.parse(upload2Text);
                    } catch (parseError) {
                        console.error('Failed to parse upload2 response:', parseError);
                        throw new Error('Failed to upload image2: Invalid response from server. Please try again.');
                    }
                    
                    if (!upload2Response.ok || !upload2Result.success) {
                        throw new Error(upload2Result.error || upload2Result.details || 'Failed to upload image2');
                    }
                    image2Url = upload2Result.url;
                    console.log('Image2 uploaded successfully:', image2Url);
                }
                
                // SADA: Pozovi Netlify Function za generiranje s URL-ovima (mali request!)
                updateLoadingStep(2, 'Starting AI generation...');
                console.log('Calling generate-image function with URLs...');
                
                // Validacija URL-ova prije slanja
                if (!image1Url || !image1Url.startsWith('http')) {
                    throw new Error('Invalid image1 URL. Please try uploading the image again.');
                }
                if (image2Url && !image2Url.startsWith('http')) {
                    throw new Error('Invalid image2 URL. Please try uploading the image again.');
                }
                
                // Timeout wrapper za fetch
                const fetchWithTimeout = (url, options, timeout = 30000) => {
                    return Promise.race([
                        fetch(url, options),
                        new Promise((_, reject) =>
                            setTimeout(() => reject(new Error('Request timeout')), timeout)
                        )
                    ]);
                };
                
                let generateResponse;
                try {
                    generateResponse = await fetchWithTimeout('/.netlify/functions/generate-image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            templateId: currentTemplate.id,
                            image1Url: image1Url,  // URL umjesto base64!
                            image2Url: image2Url,  // URL umjesto base64!
                            isCouple: isCouple
                        })
                    }, 30000); // 30 sekundi timeout
                } catch (fetchError) {
                    if (fetchError.message === 'Request timeout') {
                        throw new Error('Request timeout - the server took too long to respond. Please try again.');
                    } else if (fetchError.message && fetchError.message.includes('Failed to fetch')) {
                        throw new Error('Network error - please check your internet connection and try again.');
                    } else {
                        throw new Error('Failed to connect to server: ' + fetchError.message);
                    }
                }

                // Prvo proƒçitaj kao text da vidimo ≈°to se vraƒáa
                let responseText;
                try {
                    responseText = await generateResponse.text();
                } catch (textError) {
                    console.error('Failed to read response text:', textError);
                    throw new Error('Failed to read response from server. Please try again.');
                }
                
                console.log('Response status:', generateResponse.status);
                console.log('Response statusText:', generateResponse.statusText);
                console.log('Response headers:', Object.fromEntries(generateResponse.headers.entries()));
                console.log('Response text length:', responseText ? responseText.length : 0);
                console.log('Response text (first 500 chars):', responseText ? responseText.substring(0, 500) : 'EMPTY');
                
                // Provjeri status kod prije svega
                if (generateResponse.status === 0 || !generateResponse.status) {
                    throw new Error('Network error - no response from server. Please check your internet connection.');
                }
                
                // Provjeri da li je response prazan
                if (!responseText || responseText.trim().length === 0) {
                    console.error('Empty response received. Status:', generateResponse.status);
                    
                    // Razliƒçite poruke ovisno o status kodu
                    if (generateResponse.status === 504) {
                        throw new Error('Gateway timeout - the server took too long to respond. Please try again.');
                    } else if (generateResponse.status === 503) {
                        throw new Error('Service unavailable - the server is temporarily overloaded. Please try again in a few moments.');
                    } else if (generateResponse.status === 502) {
                        throw new Error('Bad gateway - there was an error communicating with the server. Please try again.');
                    } else {
                        throw new Error('Empty response from server (Status: ' + generateResponse.status + '). This might be a timeout or server error. Please try again.');
                    }
                }
                
                // Parse response body samo jednom
                let generateResult;
                try {
                    // Provjeri da li je response valjan JSON prije parsiranja
                    if (!responseText.trim().startsWith('{') && !responseText.trim().startsWith('[')) {
                        throw new Error('Response is not valid JSON. It might be an error page or timeout.');
                    }
                    
                    generateResult = JSON.parse(responseText);
                } catch (e) {
                    // Ako JSON parsing ne uspije, poka≈æi ≈°to se stvarno vratilo
                    console.error('Failed to parse JSON response:', e);
                    console.error('Response status:', generateResponse.status);
                    console.error('Response statusText:', generateResponse.statusText);
                    console.error('Response text (full):', responseText);
                    
                    // Ako je status error, poku≈°aj objasniti
                    if (generateResponse.status >= 500) {
                        throw new Error('Server error (500). Please try again in a few moments. If the problem persists, contact support.');
                    } else if (generateResponse.status === 504 || generateResponse.status === 408) {
                        throw new Error('Request timeout. The generation might take too long. Please try again with smaller images.');
                    } else if (generateResponse.status === 413) {
                        throw new Error('Request too large. Please try with smaller images (max 10MB).');
                    } else {
                        // Human-friendly error message
                        let friendlyMessage = 'Failed to receive valid response from server. ';
                        if (e.message && e.message.includes('unexpected end')) {
                            friendlyMessage += 'The response was incomplete or empty. This usually means the server timed out or encountered an error. Please try again.';
                        } else {
                            friendlyMessage += 'Please try again or contact support if the problem persists.';
                        }
                        throw new Error(friendlyMessage);
                    }
                }

                if (!generateResponse.ok) {
                    throw new Error(generateResult.error || generateResult.details || 'Generation failed');
                }

                console.log('Generation result:', generateResult);

                if (!generateResult.success || !generateResult.predictionId) {
                    console.error('Missing success or predictionId in result:', {
                        success: generateResult.success,
                        predictionId: generateResult.predictionId,
                        fullResult: generateResult
                    });
                    throw new Error('No prediction ID returned');
                }

                const predictionId = generateResult.predictionId;
                console.log('Prediction ID:', predictionId);
                console.log('Polling for prediction status...');

                // Poll status dok nije "succeeded" ili "failed"
                let statusResult;
                let maxAttempts = 150; // Max 5 minuta (150 * 2 sekunde)
                let attempt = 0;

                // Update to processing step
                updateLoadingStep(3, 'Processing your photos...');

                while (attempt < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 2000)); // ƒåekaj 2 sekunde
                    attempt++;

                    console.log(`Checking prediction status (attempt ${attempt}/${maxAttempts})...`);
                    
                    // Update progress based on attempts (steps 3-5 are for processing)
                    const progressPercent = Math.min(95, 30 + (attempt / maxAttempts) * 60);
                    updateProgress(progressPercent);
                    
                    // Update step based on progress
                    if (attempt < maxAttempts * 0.3) {
                        updateLoadingStep(3, 'Processing your photos...');
                    } else if (attempt < maxAttempts * 0.7) {
                        updateLoadingStep(4, 'Creating transformation...');
                    } else {
                        updateLoadingStep(5, 'Adding final touches...');
                    }
                    
                    const statusResponse = await fetch(`/.netlify/functions/check-prediction-status?predictionId=${predictionId}`);
                    const statusText = await statusResponse.text();
                    
                    try {
                        statusResult = JSON.parse(statusText);
                } catch (e) {
                    console.error('Failed to parse status response:', e);
                    console.error('Status response text:', statusText);
                    throw new Error('Failed to parse status response');
                }

                if (!statusResponse.ok) {
                    throw new Error(statusResult.error || 'Status check failed');
                }

                console.log(`Prediction status: ${statusResult.status} (attempt ${attempt})`);

                if (statusResult.status === 'succeeded') {
                    console.log('Generation successful! Image URL:', statusResult.imageUrl);
                    updateLoadingStep(6, 'Generation complete! Uploading to Bunny.net...');
                    updateProgress(95);
                    break;
                    } else if (statusResult.status === 'failed') {
                        throw new Error(statusResult.error || 'Generation failed');
                    } else if (statusResult.status === 'canceled') {
                        throw new Error('Generation was canceled');
                    }
                    // Ako je "starting" ili "processing", nastavi poll-ati
                }

                if (attempt >= maxAttempts) {
                    throw new Error('Generation timeout - prediction took too long');
                }

                if (!statusResult.imageUrl) {
                    throw new Error('No image URL in result');
                }

                // Upload na Bunny.net
                console.log('Uploading to Bunny.net...');
                console.log('Calling upload-to-bunny with:', {
                    imageUrl: statusResult.imageUrl,
                    templateId: currentTemplate.id,
                    userId: generateUserId()
                });
                const uploadResponse = await fetch('/.netlify/functions/upload-to-bunny', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        imageUrl: statusResult.imageUrl,
                        templateId: currentTemplate.id,
                        userId: generateUserId() // Generiraj unique user ID
                    })
                });

                // Parse response body samo jednom
                let uploadResult;
                try {
                    uploadResult = await uploadResponse.json();
                } catch (e) {
                    // Ako json() ne uspije, body je veƒá potro≈°en - ne poku≈°avaj ƒçitati text()
                    console.error('Failed to parse upload JSON response:', e);
                    throw new Error('Failed to parse upload response: ' + (e.message || 'Invalid JSON'));
                }

                if (!uploadResponse.ok) {
                    throw new Error(uploadResult.error || uploadResult.details || 'Upload failed');
                }

                console.log('Upload result:', uploadResult);

                // Prika≈æi rezultate
                showResults(uploadResult.cdnUrl, null);
                
            } catch (error) {
                console.error('Generation error:', error);
                console.error('Error type:', typeof error);
                console.error('Error details:', {
                    message: error?.message,
                    name: error?.name,
                    stack: error?.stack,
                    toString: error?.toString()
                });
                
                // Osiguraj da uvijek imamo valjan error message
                let errorMessage = 'An error occurred while generating your transformation.';
                
                // Detaljno logiranje za debugging (posebno va≈æno za Android)
                console.error('=== ERROR DETAILS ===');
                console.error('Error object:', error);
                console.error('Error type:', typeof error);
                console.error('Error constructor:', error?.constructor?.name);
                console.error('Error keys:', error ? Object.keys(error) : 'N/A');
                
                if (error) {
                    // Provjeri razliƒçite naƒçine kako error mo≈æe biti predstavljen
                    if (error.message && typeof error.message === 'string' && error.message.trim().length > 0) {
                        errorMessage = error.message;
                    } else if (typeof error === 'string' && error.trim().length > 0) {
                        errorMessage = error;
                    } else if (error.toString && typeof error.toString === 'function') {
                        const errorString = error.toString();
                        if (errorString !== '[object Object]' && errorString !== '[object Error]') {
                            errorMessage = errorString;
                        }
                    } else if (error.name && typeof error.name === 'string') {
                        errorMessage = `Error: ${error.name}`;
                    } else if (error.error && typeof error.error === 'string') {
                        errorMessage = error.error;
                    } else {
                        // Fallback - poku≈°aj izvuƒái bilo ≈°to korisno
                        try {
                            const errorJson = JSON.stringify(error);
                            if (errorJson && errorJson !== '{}' && errorJson !== 'null') {
                                errorMessage = `Error: ${errorJson.substring(0, 200)}`;
                            }
                        } catch (e) {
                            // Ako ni JSON.stringify ne radi, koristi default poruku
                            errorMessage = 'An unexpected error occurred. Please try again or contact support if the problem persists.';
                        }
                    }
                }
                
                // Ako je error message jo≈° uvijek prazan ili "undefined", koristi default
                if (!errorMessage || errorMessage.trim().length === 0 || errorMessage === 'undefined') {
                    errorMessage = 'An unexpected error occurred. Please try again or contact support if the problem persists.';
                }
                
                console.error('Final error message:', errorMessage);
                
                showError(errorMessage, true);
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('generateButton').disabled = false;
                updateProgress(0); // Reset progress
            }
        });

        // ============================================
        // HEIC CONVERSION
        // ============================================
        async function convertHeicToJpegInBrowser(file) {
            const isHeic = file.type === 'image/heic' || file.type === 'image/heif' || 
                           file.name.toLowerCase().endsWith('.heic') || 
                           file.name.toLowerCase().endsWith('.heif');
            
            if (!isHeic) {
                return file; // Nije HEIC, vrati original
            }
            
            console.log('Converting HEIC to JPEG:', file.name);
            
            try {
                // Provjeri je li biblioteka uƒçitana
                if (typeof heic2any === 'undefined') {
                    throw new Error('HEIC converter library not loaded');
                }
                
                // Konvertuj HEIC u JPEG
                const jpegBlob = await heic2any({
                    blob: file,
                    toType: 'image/jpeg',
                    quality: 0.85 // 85% kvalitete
                });
                
                // heic2any vraƒáa array ako je vi≈°e slika, uzmi prvu
                const blob = Array.isArray(jpegBlob) ? jpegBlob[0] : jpegBlob;
                
                // Kreiraj novi File objekt
                const jpegFile = new File([blob], 
                    file.name.replace(/\.(heic|heif)$/i, '.jpg'), {
                        type: 'image/jpeg',
                        lastModified: Date.now()
                    });
                
                console.log('HEIC conversion successful:', {
                    original: `${(file.size / 1024 / 1024).toFixed(2)}MB (${file.type})`,
                    converted: `${(blob.size / 1024 / 1024).toFixed(2)}MB (image/jpeg)`
                });
                
                return jpegFile;
                
            } catch (error) {
                console.error('HEIC conversion failed:', error);
                throw new Error(`Cannot convert HEIC image: ${error.message}. Please save as JPEG first.`);
            }
        }

        // ============================================
        // IMAGE VALIDATION
        // ============================================
        function validateImage(file) {
            return new Promise((resolve, reject) => {
                const minWidth = 400;
                const minHeight = 400;
                const maxSize = 10 * 1024 * 1024; // 10MB
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/heic', 'image/heif'];
                
                // Provjeri ekstenziju za Samsung HEIC
                const fileName = file.name.toLowerCase();
                const isHeic = fileName.endsWith('.heic') || fileName.endsWith('.heif');
                const isAllowedType = allowedTypes.includes(file.type) || isHeic;
                
                // Check file type
                if (!isAllowedType) {
                    reject(new Error(`Invalid file type (${file.type}). Samsung users: Please save as JPEG or disable Motion Photo.`));
                    return;
                }
                
                // Check file size
                if (file.size > maxSize) {
                    reject(new Error(`Image too large (${(file.size / 1024 / 1024).toFixed(1)}MB). Maximum size: 10MB`));
                    return;
                }
                
                // Check image dimensions
                const img = new Image();
                img.onload = function() {
                    if (img.width < minWidth || img.height < minHeight) {
                        reject(new Error(`Image too small (${img.width}x${img.height}px). Minimum: ${minWidth}x${minHeight}px`));
                    } else {
                        resolve({ 
                            width: img.width, 
                            height: img.height,
                            size: file.size,
                            type: file.type
                        });
                    }
                    URL.revokeObjectURL(img.src);
                };
                img.onerror = () => {
                    reject(new Error('Invalid image file. Please choose a valid image.'));
                };
                img.src = URL.createObjectURL(file);
            });
        }
        
        function showValidationMessage(message, type = 'success') {
            const validationDiv = document.getElementById('validationMessage');
            validationDiv.textContent = message;
            validationDiv.className = `validation-message ${type} show`;
            setTimeout(() => {
                validationDiv.classList.remove('show');
            }, 5000);
        }
        
        // ============================================
        // PROGRESS TRACKING
        // ============================================
        const loadingStates = [
            { step: 1, message: 'Uploading images...', icon: 'üì§', estimatedTime: 5 },
            { step: 2, message: 'Starting AI generation...', icon: 'ü§ñ', estimatedTime: 5 },
            { step: 3, message: 'Processing your photos...', icon: '‚ú®', estimatedTime: 30 },
            { step: 4, message: 'Creating transformation...', icon: 'üé®', estimatedTime: 60 },
            { step: 5, message: 'Adding final touches...', icon: 'üé≠', estimatedTime: 20 },
            { step: 6, message: 'Complete! Preparing download...', icon: '‚úÖ', estimatedTime: 5 }
        ];
        
        let currentStep = 0;
        let startTime = null;
        
        function updateLoadingStep(step, customMessage = null) {
            if (step < 1 || step > loadingStates.length) return;
            
            currentStep = step;
            const state = loadingStates[step - 1];
            
            // Update step indicators
            for (let i = 1; i <= loadingStates.length; i++) {
                const stepEl = document.getElementById(`step${i}`);
                if (stepEl) {
                    stepEl.classList.remove('active', 'completed');
                    if (i < step) {
                        stepEl.classList.add('completed');
                    } else if (i === step) {
                        stepEl.classList.add('active');
                    }
                }
            }
            
            // Update loading message
            const loadingMessage = document.getElementById('loadingMessage');
            const stepIcon = document.getElementById('stepIcon');
            if (loadingMessage) {
                loadingMessage.textContent = customMessage || state.message;
            }
            if (stepIcon) {
                stepIcon.textContent = state.icon;
            }
            
            // Update progress bar
            const progressPercent = ((step - 1) / (loadingStates.length - 1)) * 100;
            updateProgress(progressPercent);
        }
        
        function updateProgress(percent) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            if (progressFill) {
                progressFill.style.width = `${Math.min(100, Math.max(0, percent))}%`;
            }
            
            if (progressText) {
                progressText.textContent = `${Math.round(percent)}%`;
            }
            
            // Update time estimate
            if (startTime && percent > 0 && percent < 100) {
                const elapsed = (Date.now() - startTime) / 1000;
                const estimated = elapsed / (percent / 100);
                const remaining = Math.max(0, estimated - elapsed);
                updateTimeEstimate(remaining);
            }
        }
        
        function updateTimeEstimate(remainingSeconds) {
            const timeEstimate = document.getElementById('timeEstimate');
            if (timeEstimate && remainingSeconds > 0) {
                const minutes = Math.floor(remainingSeconds / 60);
                const seconds = Math.floor(remainingSeconds % 60);
                if (minutes > 0) {
                    timeEstimate.textContent = `Estimated time remaining: ~${minutes} minute${minutes > 1 ? 's' : ''}`;
                } else {
                    timeEstimate.textContent = `Estimated time remaining: ~${seconds} second${seconds > 1 ? 's' : ''}`;
                }
            }
        }
        
        function startProgressTracking() {
            startTime = Date.now();
            currentStep = 0;
            updateLoadingStep(1);
        }
        
        // ============================================
        // ERROR RECOVERY & RETRY
        // ============================================
        let lastGenerationData = null;
        
        function saveGenerationData(data) {
            lastGenerationData = {
                ...data,
                timestamp: Date.now()
            };
            // Also save to localStorage for persistence
            try {
                localStorage.setItem('lastGenerationData', JSON.stringify(lastGenerationData));
            } catch (e) {
                console.warn('Could not save to localStorage:', e);
            }
        }
        
        function retryGeneration() {
            if (!lastGenerationData) {
                showError('No previous generation data found. Please upload images again.');
                return;
            }
            
            // Hide error recovery
            document.getElementById('errorRecovery').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            
            // Restore images if they exist
            if (lastGenerationData.uploadedImages) {
                uploadedImages = lastGenerationData.uploadedImages;
                updatePreview();
            }
            
            // Retry generation
            document.getElementById('generateButton').click();
        }
        
        function saveProgress() {
            try {
                const progressData = {
                    templateId: currentTemplate?.id,
                    uploadedImages: uploadedImages,
                    timestamp: Date.now()
                };
                localStorage.setItem('lovestoriesProgress', JSON.stringify(progressData));
                showValidationMessage('‚úÖ Progress saved! You can continue later.', 'success');
            } catch (e) {
                showValidationMessage('‚ùå Could not save progress: ' + e.message, 'error');
            }
        }
        
        function loadSavedProgress() {
            try {
                const saved = localStorage.getItem('lovestoriesProgress');
                if (saved) {
                    const progressData = JSON.parse(saved);
                    // Note: File objects can't be stored in localStorage
                    // This would need to be implemented differently if needed
                    showValidationMessage('üíæ Saved progress found! Upload your images again to continue.', 'warning');
                }
            } catch (e) {
                console.warn('Could not load saved progress:', e);
            }
        }
        
        // ============================================
        // IMPROVED ERROR HANDLING
        // ============================================
        function showError(message, showRetry = true) {
            const errorDiv = document.getElementById('errorMessage');
            const errorContent = document.getElementById('errorContent');
            const errorRecovery = document.getElementById('errorRecovery');
            
            if (errorContent) {
                errorContent.textContent = message;
            }
            
            if (errorDiv) {
                errorDiv.style.display = 'block';
            }
            
            if (errorRecovery && showRetry) {
                errorRecovery.style.display = 'block';
            } else if (errorRecovery) {
                errorRecovery.style.display = 'none';
            }
            
            // Hide loading section
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('generateButton').disabled = false;
        }
        
        // ============================================
        // Helper funkcije
        // ============================================
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function generateUserId() {
            return 'user-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }


        function showResults(imageUrl, videoUrl) {
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = '';
            
            if (imageUrl) {
                const imageDiv = document.createElement('div');
                imageDiv.className = 'result-item';
                    imageDiv.innerHTML = `
                    <h4>üì∏ Transformed Image</h4>
                    <img src="${imageUrl}" alt="Result">
                    <a href="${imageUrl}" download="lovestories-image.jpg" class="download-button">‚¨áÔ∏è Download Image</a>
                `;
                resultsContainer.appendChild(imageDiv);
                
                // Generiraj QR kod za sliku
                generateQRCodeForImage(imageUrl, resultsContainer);
            }
            
            if (videoUrl) {
                const videoDiv = document.createElement('div');
                videoDiv.className = 'result-item';
                videoDiv.innerHTML = `
                    <h4>üé¨ Transformed Video</h4>
                    <video src="${videoUrl}" controls></video>
                    <a href="${videoUrl}" download="lovestories-video.mp4" class="download-button">‚¨áÔ∏è Download Video</a>
                `;
                resultsContainer.appendChild(videoDiv);
            }
            
            document.getElementById('resultsSection').classList.add('show');
            document.getElementById('loadingSection').style.display = 'none';
            
            // Show 100% progress
            updateProgress(100);
            updateLoadingStep(6, 'Complete!');
            
            // Clear saved progress
            try {
                localStorage.removeItem('lovestoriesProgress');
            } catch (e) {
                console.warn('Could not clear saved progress:', e);
            }
        }
        
        // Generiraj QR kod za sliku
        function generateQRCodeForImage(imageUrl, container) {
            const qrDiv = document.createElement('div');
            qrDiv.className = 'result-item';
            qrDiv.style.textAlign = 'center';
            qrDiv.style.padding = '20px';
            qrDiv.style.background = '#f8f9fa';
            qrDiv.style.borderRadius = '12px';
            qrDiv.style.marginTop = '20px';
            qrDiv.innerHTML = '<h4>üì± Scan QR code to access on your phone</h4><div id="qrCodeContainer" style="display: inline-block; padding: 20px; background: white; border-radius: 8px; margin-top: 10px;"></div>';
            container.appendChild(qrDiv);
            
            const qrContainer = qrDiv.querySelector('#qrCodeContainer');
            qrContainer.innerHTML = '<div style="text-align: center; padding: 20px;">Loading QR code...</div>';
            
            // Check if QRCode library is loaded
            if (typeof QRCode === 'undefined') {
                console.error('QRCode library not loaded');
                qrContainer.innerHTML = '<p style="color: red;">QR library not loaded</p>';
                return;
            }
            
            // qrcodejs uses constructor approach
            try {
                // Clear previous QR code
                qrContainer.innerHTML = '';
                
                // Generate QR code using qrcodejs API
                new QRCode(qrContainer, {
                    text: imageUrl,
                    width: 250,
                    height: 250,
                    colorDark: '#667eea',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.M
                });
                
                console.log('QR code generated successfully');
            } catch (error) {
                console.error('QR code error:', error);
                qrContainer.innerHTML = '<p style="color: red;">Error generating QR code</p>';
            }
        }

        // Initialize
        loadTemplateInfo();
        checkGenerateButton();
        loadSavedProgress(); // Try to load any saved progress
    </script>
</body>
</html>

